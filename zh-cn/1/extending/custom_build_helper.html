<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Creating a custom build helper for Conan &mdash; conan 1.65.0 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/css/conan.css?v=f9087e22" />

  
    <link rel="shortcut icon" href="../_static/conan-favicon.png"/>
    <link rel="canonical" href="https://projects.localizethedocs.org/conan-docs-l10n/extending/custom_build_helper.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=b1fa76c8"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/translations.js?v=beaddf03"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Hooks" href="hooks.html" />
    <link rel="prev" title="Python requires (legacy)" href="python_requires_legacy.html" />


 



</script>
<script type="text/javascript" src="../ltd-provenance.js"></script>
<script type="text/javascript" src="../ltd-current.js"></script>
<script type="text/javascript" src="../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../ltd-flyout.js"></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/conan-logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conan_v2.html">Conan migration guide to 2.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../training_courses.html">Training Courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_packages.html">Using packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../creating_packages.html">Creating Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uploading_packages.html">Uploading Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developing_packages.html">Developing packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devtools.html">Package apps and devtools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versioning.html">Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mastering.html">Mastering Conan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../systems_cross_building.html">Systems and cross building</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../extending.html">Extending Conan</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="custom_settings.html">Customizing settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_requires.html">Python requires</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_requires_legacy.html">Python requires (legacy)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Creating a custom build helper for Conan</a></li>
<li class="toctree-l2"><a class="reference internal" href="hooks.html">Hooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="template_system.html">Template system</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../integrations.html">Integrations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howtos.html">Howtos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cheatsheet.html">Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../videos.html">Videos and links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">conan</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div class="admonition warning wy-text-center" style="position:sticky;top:0;background: #fcfcfc;padding: inherit;z-index:1" id="conan-banners">
            
            <div style="border: 2px solid #eb8484;background-color: #ffcaca;padding: 3px;margin-bottom: 5px">
              <p>This document is for a <b>"1.X" legacy</b> Conan version, <b>which is no longer recommended</b>. Please update to Conan 2, <a href="https://docs.conan.io/2/">click here to read the <b>Conan 2</b> documentation</a></p>
            </div>
            
            <div style="border: 2px solid #c6ac58;background-color: #f7ecc6;padding: 3px">
              <p>Conan Center has stopped receiving updates for Conan 1.x packages. A new https://center2.conan.io Conan 2-only remote is now available. <a href="https://blog.conan.io/2024/09/30/Conan-Center-will-stop-receiving-updates-for-Conan-1.html">Read the blog post</a></p>
            </div>
          </div>
          <!--@ OUTDATED_VERSION_PLACEHOLDER_BEGIN @
          <div>
            <div class="admonition warning wy-text-center" style="position:sticky">
              <p>This document is for an <b>outdated</b> Conan version.
              <a href="https://docs.conan.io/2/@LATEST_DOC_PAGE_URL@">Click here to read the <b>latest</b> documentation</a></p>
             </div>
          </div>
          @ OUTDATED_VERSION_PLACEHOLDER_END @-->
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../extending.html">Extending Conan</a></li>
      <li class="breadcrumb-item active">Creating a custom build helper for Conan</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/conan-io/docs/blob/master/extending/custom_build_helper.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="creating-a-custom-build-helper-for-conan">
<span id="custom-build-helper"></span><h1>Creating a custom build helper for Conan<a class="headerlink" href="#creating-a-custom-build-helper-for-conan" title="Link to this heading"></a></h1>
<p>If Conan doesn’t have a build helper for the build tool you are using, you can create a custom build helper
with the <a class="reference internal" href="python_requires.html#python-requires"><span class="std std-ref">Python requires</span></a>. You can create a package defining the build helper for that
build tool and reuse it later in the consumers importing the build helper as a
<em>Python requires</em>.</p>
<p>As you probably know, build helpers are wrappers of the build tool that help with the conversion
of the Conan settings to the build tool’s ones. They assist users with the compilation of libraries
and applications in the <cite>build()</cite> method of a recipe.</p>
<p>As an example, we are going to create a minimal implementation of a build helper for the <a class="reference external" href="https://waf.io/">Waf build
system</a> . First, we need to create a recipe for the <code class="docutils literal notranslate"><span class="pre">python_requires</span></code> that will
export <em>waf_environment.py</em>, where all the implementation of the build helper is.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">conans</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConanFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">waf_environment</span><span class="w"> </span><span class="kn">import</span> <span class="n">WafBuildEnvironment</span>


<span class="k">class</span><span class="w"> </span><span class="nc">PythonRequires</span><span class="p">(</span><span class="n">ConanFile</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;waf-build-helper&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>
    <span class="n">exports</span> <span class="o">=</span> <span class="s2">&quot;waf_environment.py&quot;</span>
</pre></div>
</div>
<p>As we said, the build helper is responsible for translating Conan settings to something that the
build tool understands. That can be passing arguments through the command line when invoking the tool
or creating files that will take as an input. In this case, the build helper for <em>Waf</em> will create
one file named <em>waf_toolchain.py</em> that will contain linker and compiler flags based on the Conan
settings.</p>
<p>To pass that information to <cite>Waf</cite> in the file, you have to modify its configuration environment
through the <code class="docutils literal notranslate"><span class="pre">conf.env</span></code> variable setting all the relevant flags. We will also define a <code class="docutils literal notranslate"><span class="pre">configure</span></code>
and a <code class="docutils literal notranslate"><span class="pre">build</span></code> method. Let’s see how the most important parts of <em>waf_environment.py</em> file that
defines the build helper could look. In this case, for simplification, the build helper will only add
flags depending on the conan setting value for the <code class="docutils literal notranslate"><span class="pre">build_type</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WafBuildEnvironment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conanfile</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conanfile</span> <span class="o">=</span> <span class="n">conanfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conanfile</span><span class="o">.</span><span class="n">settings</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_type_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;Visual Studio&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_type</span> <span class="o">==</span> <span class="s2">&quot;Debug&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;/Zi&#39;</span><span class="p">,</span> <span class="s1">&#39;/FS&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_type</span> <span class="o">==</span> <span class="s2">&quot;Release&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;/O2&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_type</span> <span class="o">==</span> <span class="s2">&quot;Debug&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-g&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_type</span> <span class="o">==</span> <span class="s2">&quot;Release&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-O3&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_toolchain_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;def configure(conf):&quot;</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    conf.env.CXXFLAGS = conf.env.CXXFLAGS or []&quot;</span><span class="p">)</span>
        <span class="n">_build_type_flags</span> <span class="o">=</span> <span class="n">build_type_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    conf.env.CXXFLAGS.extend(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_build_type_flags</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_toolchain_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;waf_conan_toolchain.py&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_toolchain_content</span><span class="p">()</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conanfile</span><span class="o">.</span><span class="n">build_folder</span>
        <span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_toolchain_file</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;waf configure &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conanfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;waf build &quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conanfile</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>
</div>
<p>Now you can export your custom build helper to the local cache, or upload to a remote:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>conan<span class="w"> </span><span class="nb">export</span><span class="w"> </span>.
</pre></div>
</div>
<p>After exporting this package to the local cache you can use this custom build helper to compile
our packages using the <em>Waf</em> build system. Just add the necessary configuration files for <em>Waf</em> and
import the <code class="docutils literal notranslate"><span class="pre">python_requires</span></code>. The <em>conanfile.py</em> of that package could look similar to this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">conans</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConanFile</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TestWafConan</span><span class="p">(</span><span class="n">ConanFile</span><span class="p">):</span>
    <span class="n">python_requires</span> <span class="o">=</span> <span class="s2">&quot;waf-build-helper/0.1&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="s2">&quot;os&quot;</span><span class="p">,</span> <span class="s2">&quot;compiler&quot;</span><span class="p">,</span> <span class="s2">&quot;build_type&quot;</span><span class="p">,</span> <span class="s2">&quot;arch&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;waf-consumer&quot;</span>
    <span class="n">generators</span> <span class="o">=</span> <span class="s2">&quot;Waf&quot;</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="s2">&quot;mylib-waf/1.0&quot;</span>
    <span class="n">tool_requires</span> <span class="o">=</span> <span class="s2">&quot;WafGen/0.1&quot;</span><span class="p">,</span> <span class="s2">&quot;waf/2.0.19&quot;</span>
    <span class="n">exports_sources</span> <span class="o">=</span> <span class="s2">&quot;wscript&quot;</span><span class="p">,</span> <span class="s2">&quot;main.cpp&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">waf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">python_requires</span><span class="p">[</span><span class="s2">&quot;waf-build-helper&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">WafBuildEnvironment</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">waf</span><span class="o">.</span><span class="n">configure</span><span class="p">()</span>
        <span class="n">waf</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>
</div>
<p>As you can see in the <em>conanfile.py</em> we also are requiring the build tool and a generator for that
build tool. If you want more detailed information on how to integrate your own build system in Conan,
please <a class="reference external" href="https://blog.conan.io/2019/07/24/C++-build-systems-new-integrations-in-Conan-package-manager.html">check this blog-post about that topic</a>.</p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="python_requires_legacy.html" class="btn btn-neutral float-left" title="Python requires (legacy)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="hooks.html" class="btn btn-neutral float-right" title="Hooks" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2024, JFrog.
      <span class="lastupdated">最后更新于 10月 27, 2025.
      </span></p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script>


 


</body>
</html>